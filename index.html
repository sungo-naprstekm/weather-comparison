<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porovnání počasí s AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .weather-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .remove-btn {
            cursor: pointer;
            font-weight: bold;
            color: #ef4444;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .remove-btn:hover {
            opacity: 1;
        }
        #suggestions-box .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        /* Styl pro modální okno */
        #ai-modal-backdrop {
            transition: opacity 0.3s ease;
        }
        #ai-modal-content {
            transition: transform 0.3s ease;
        }
        .gemini-btn {
            cursor: pointer;
            font-size: 1.25rem; /* 20px */
            opacity: 0.6;
            transition: all 0.2s ease-in-out;
        }
        .gemini-btn:hover {
            opacity: 1;
            transform: scale(1.2) rotate(15deg);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Porovnání počasí s AI</h1>
            <p class="text-gray-600 mt-2">Klikněte na ✨ pro slovní předpověď od Gemini</p>
        </header>

        <!-- Formulář pro přidání města -->
        <div id="add-form-container" class="max-w-md mx-auto mb-8">
            <div class="relative p-4 bg-white rounded-lg shadow">
                <form id="add-location-form" class="flex gap-2">
                    <input type="text" id="location-input" placeholder="Zadejte název města..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Přidat</button>
                </form>
                <div id="suggestions-box" class="absolute top-full left-4 right-4 bg-white border border-gray-200 rounded-b-md shadow-lg z-20 hidden"></div>
                <p id="error-message" class="text-red-500 text-sm mt-2 text-center"></p>
            </div>
        </div>

        <!-- Kontejner pro tabulku s počasím -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full text-center">
                <thead id="table-header" class="bg-gray-200"></thead>
                <tbody id="table-body" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Data poskytuje <a href="https://www.met.no/" target="_blank" class="text-blue-600 hover:underline">MET Norway</a>. Geokódování zajišťuje <a href="https://open-meteo.com/" target="_blank" class="text-blue-600 hover:underline">Open-Meteo</a>.</p>
        </footer>
    </div>
    
    <!-- Modální okno pro AI předpověď -->
    <div id="ai-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex justify-center items-center" onclick="hideAiModal()">
        <div id="ai-modal-content" class="bg-white rounded-lg shadow-2xl p-6 m-4 max-w-md w-full transform scale-95" onclick="event.stopPropagation()">
            <h3 id="ai-modal-title" class="text-xl font-bold text-gray-800 mb-4">Slovní předpověď</h3>
            <div id="ai-modal-body" class="text-gray-700">
                <!-- Obsah generovaný AI se zobrazí zde -->
            </div>
            <button onclick="hideAiModal()" class="mt-6 w-full bg-gray-200 text-gray-800 font-semibold py-2 rounded-md hover:bg-gray-300 transition-colors">Zavřít</button>
        </div>
    </div>

    <script>
        const addLocationForm = document.getElementById('add-location-form');
        const locationInput = document.getElementById('location-input');
        const errorMessage = document.getElementById('error-message');
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('table-body');
        const suggestionsBox = document.getElementById('suggestions-box');
        const addFormContainer = document.getElementById('add-form-container');
        const aiModalBackdrop = document.getElementById('ai-modal-backdrop');
        const aiModalContent = document.getElementById('ai-modal-content');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalBody = document.getElementById('ai-modal-body');

        let locations = [];
        let forecastsCache = []; // Cache pro uložená data
        let debounceTimer;

        // --- Funkce pro API volání ---

        async function getCitySuggestions(query) {
            const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=cs&format=json`;
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) { console.error("Chyba při načítání návrhů:", error); return { results: [] }; }
        }

        async function getWeatherData(lat, lon) {
            const url = `https://api.met.no/weatherapi/locationforecast/2.0/complete?lat=${lat}&lon=${lon}`;
            const headers = new Headers({ 'User-Agent': 'MyWeatherTable/1.3-Gemini https://example.com' });
            try {
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error(`Chyba sítě: ${response.statusText}`);
                return await response.json();
            } catch (error) { console.error(`Nepodařilo se načíst data o počasí pro ${lat}, ${lon}:`, error); return null; }
        }
        
        // --- NOVÁ FUNKCE PRO GEMINI API ---
        async function getGeminiForecast(prompt) {
            const apiKey = ""; // Klíč bude vložen prostředím
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 150,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Chyba API: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                }
                return "Nepodařilo se získat odpověď od AI.";
            } catch (error) {
                console.error("Chyba při volání Gemini API:", error);
                return "Při komunikaci s AI službou nastala chyba.";
            }
        }


        // --- Funkce pro zpracování dat ---

        function processDailyForecast(timeseries) {
            const dailyData = {};
            timeseries.forEach(entry => {
                const date = entry.time.split('T')[0];
                if (!dailyData[date]) dailyData[date] = { temps: [] };
                if (entry.data.instant?.details) dailyData[date].temps.push(entry.data.instant.details.air_temperature);
            });

            const forecast = [];
            for (const date in dailyData) {
                if (dailyData[date].temps.length === 0) continue;
                const minTemp = Math.round(Math.min(...dailyData[date].temps));
                const maxTemp = Math.round(Math.max(...dailyData[date].temps));
                let mainSymbol = 'clearsky_day';
                const noonEntry = timeseries.find(e => e.time.startsWith(date + 'T12:'));
                if (noonEntry?.data.next_1_hours?.summary) {
                    mainSymbol = noonEntry.data.next_1_hours.summary.symbol_code;
                } else {
                    const firstEntryWithSymbol = timeseries.find(e => e.time.startsWith(date) && e.data.next_1_hours?.summary?.symbol_code);
                    if (firstEntryWithSymbol) mainSymbol = firstEntryWithSymbol.data.next_1_hours.summary.symbol_code;
                }
                forecast.push({ date, minTemp, maxTemp, symbol: mainSymbol });
            }
            return forecast.slice(0, 10);
        }

        // --- Funkce pro vykreslování UI ---

        async function renderTable() {
            if (locations.length === 0) {
                tableHeader.innerHTML = '<tr><th class="p-4 font-semibold text-gray-600">Přidejte lokalitu pro zobrazení předpovědi</th></tr>';
                tableBody.innerHTML = '';
                return;
            }
            renderHeader();
            renderBodyWithLoading();
            const allForecasts = await Promise.all(locations.map(loc => getWeatherData(loc.lat, loc.lon)));
            forecastsCache = allForecasts.map(data => data ? processDailyForecast(data.properties.timeseries) : null);
            renderBodyWithData(forecastsCache);
        }

        function renderHeader() {
            let headerHTML = '<tr><th class="p-3 font-semibold text-left w-36">Datum</th>';
            locations.forEach((loc, index) => {
                headerHTML += `<th class="p-3 font-semibold whitespace-nowrap">${loc.name} <span class="remove-btn" onclick="removeLocation(${index})">×</span></th>`;
            });
            headerHTML += '</tr>';
            tableHeader.innerHTML = headerHTML;
        }

        function renderBodyWithLoading() {
            let bodyHTML = '';
            for (let i = 0; i < 10; i++) {
                bodyHTML += `<tr><td class="p-3 text-left text-gray-600 font-medium">${getFormattedDate(i)}</td>`;
                for (let j = 0; j < locations.length; j++) {
                    bodyHTML += '<td class="p-3"><div class="flex justify-center"><div class="loader"></div></div></td>';
                }
                bodyHTML += '</tr>';
            }
            tableBody.innerHTML = bodyHTML;
        }

        function getIconUrl(symbol) {
            const baseUrl = 'https://cdn.jsdelivr.net/gh/nrkno/yr-weather-symbols@main/dist/svg/';
            return `${baseUrl}${symbol}.svg`;
        }

        function renderBodyWithData(forecasts) {
            let bodyHTML = '';
            const numDays = forecasts.length > 0 && forecasts[0] ? forecasts[0].length : 0;
            for (let dayIndex = 0; dayIndex < numDays; dayIndex++) {
                bodyHTML += `<tr class="hover:bg-gray-50 ${dayIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                const dateValue = forecasts[0]?.[dayIndex]?.date;
                bodyHTML += `<td class="p-3 text-left text-gray-700 font-semibold">${getFormattedDate(dayIndex, dateValue)}</td>`;
                forecasts.forEach((locForecast, locIndex) => {
                    if (locForecast?.[dayIndex]) {
                        const day = locForecast[dayIndex];
                        const iconUrl = getIconUrl(day.symbol);
                        bodyHTML += `<td class="p-3"><div class="flex flex-col items-center">
                            <img src="${iconUrl}" alt="${day.symbol}" class="weather-icon">
                            <div class="font-semibold mt-1">${day.maxTemp}°</div>
                            <div class="text-gray-500">${day.minTemp}°</div>
                            <div class="mt-2 gemini-btn" onclick="showAiModal(${locIndex}, ${dayIndex})" title="Získat slovní předpověď">✨</div>
                        </div></td>`;
                    } else {
                        bodyHTML += '<td class="p-3 text-red-500">Chyba</td>';
                    }
                });
                bodyHTML += '</tr>';
            }
            tableBody.innerHTML = bodyHTML;
        }
        
        function renderSuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) {
                suggestionsBox.classList.add('hidden');
                return;
            }
            suggestionsBox.innerHTML = '';
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'p-3 cursor-pointer suggestion-item border-t border-gray-100';
                item.textContent = `${suggestion.name}${suggestion.admin1 ? ', ' + suggestion.admin1 : ''} (${suggestion.country})`;
                item.addEventListener('click', () => selectSuggestion(suggestion));
                suggestionsBox.appendChild(item);
            });
            suggestionsBox.classList.remove('hidden');
        }

        // --- Obsluha událostí a pomocné funkce ---

        function selectSuggestion(suggestion) {
            const newLocation = { name: suggestion.name, lat: suggestion.latitude, lon: suggestion.longitude };
            if (!locations.some(loc => loc.name === newLocation.name)) {
                locations.push(newLocation);
                renderTable();
            }
            locationInput.value = '';
            suggestionsBox.classList.add('hidden');
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const cityName = locationInput.value.trim();
            if (!cityName) return;
            suggestionsBox.classList.add('hidden');
            const data = await getCitySuggestions(cityName);
            if(data.results && data.results.length > 0) {
                selectSuggestion(data.results[0]);
            } else {
                errorMessage.textContent = `Město "${cityName}" nebylo nalezeno.`;
            }
        }
        
        locationInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const query = locationInput.value.trim();
            if (query.length < 2) {
                suggestionsBox.classList.add('hidden');
                return;
            }
            debounceTimer = setTimeout(async () => {
                const data = await getCitySuggestions(query);
                renderSuggestions(data.results);
            }, 300);
        });
        
        document.addEventListener('click', (e) => {
            if (!addFormContainer.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });

        window.removeLocation = (index) => {
            locations.splice(index, 1);
            forecastsCache.splice(index, 1);
            renderTable();
        }

        function getFormattedDate(dayOffset, dateString = null) {
            const date = dateString ? new Date(dateString) : new Date();
            if (!dateString) date.setDate(date.getDate() + dayOffset);
            const options = { weekday: 'short', day: 'numeric', month: 'numeric' };
            let formatted = new Intl.DateTimeFormat('cs-CZ', options).format(date);
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        }
        
        // --- NOVÉ FUNKCE PRO MODÁLNÍ OKNO ---
        
        window.showAiModal = async (locIndex, dayIndex) => {
            const location = locations[locIndex];
            const dayForecast = forecastsCache[locIndex][dayIndex];
            
            aiModalTitle.textContent = `Předpověď pro ${location.name}`;
            aiModalBody.innerHTML = '<div class="flex justify-center items-center h-24"><div class="loader"></div></div><p class="text-center mt-2">Generuji slovní předpověď...</p>';
            aiModalBackdrop.classList.remove('hidden');
            aiModalContent.classList.remove('scale-95');
            
            const symbolDescription = dayForecast.symbol.replace(/_/g, ' ').replace('day', 'den').replace('night', 'noc');
            const prompt = `Vytvoř krátkou a přátelskou slovní předpověď počasí pro dané místo a den ve formátu prostého textu. Buď stručný (2-3 věty). Nepoužívej markdown. Data: Místo: ${location.name}, Datum: ${getFormattedDate(0, dayForecast.date)}, Minimální teplota: ${dayForecast.minTemp}°C, Maximální teplota: ${dayForecast.maxTemp}°C, Popis počasí: ${symbolDescription}.`;

            const aiText = await getGeminiForecast(prompt);
            aiModalBody.textContent = aiText;
        };

        window.hideAiModal = () => {
            aiModalContent.classList.add('scale-95');
            aiModalBackdrop.classList.add('hidden');
        };

        function init() {
            addLocationForm.addEventListener('submit', handleFormSubmit);
            locations = [
                { name: "Praha", lat: 50.07, lon: 14.43 },
                { name: "Brno", lat: 49.19, lon: 16.60 }
            ];
            renderTable();
        }

        init();
    </script>
</body>
</html>
